/**
 * æ›´æ–°æ—¥æœŸï¼š2024-04-05 15:30:15
 * ç”¨æ³•ï¼šSub-Store è„šæœ¬æ“ä½œæ·»åŠ 
 * rename.js ä»¥ä¸‹æ˜¯æ­¤è„šæœ¬æ”¯æŒçš„å‚æ•°ï¼Œå¿…é¡»ä»¥ # ä¸ºå¼€å¤´å¤šä¸ªå‚æ•°ä½¿ç”¨"&"è¿žæŽ¥ï¼Œå‚è€ƒä¸Šè¿°åœ°å€ä¸ºä¾‹ä½¿ç”¨å‚æ•°ã€‚ ç¦ç”¨ç¼“å­˜url#noCache
 *
 *** ä¸»è¦å‚æ•°
 * [in=] è‡ªåŠ¨åˆ¤æ–­æœºåœºèŠ‚ç‚¹åç±»åž‹ ä¼˜å…ˆçº§ zh(ä¸­æ–‡) -> flag(å›½æ——) -> quan(è‹±æ–‡å…¨ç§°) -> en(è‹±æ–‡ç®€å†™)
 * å¦‚æžœä¸å‡†çš„æƒ…å†µ, å¯ä»¥åŠ å‚æ•°æŒ‡å®š:
 *
 * [nm]    ä¿ç•™æ²¡æœ‰åŒ¹é…åˆ°çš„èŠ‚ç‚¹
 * [in=zh] æˆ–in=cnè¯†åˆ«ä¸­æ–‡
 * [in=en] æˆ–in=us è¯†åˆ«è‹±æ–‡ç¼©å†™
 * [in=flag] æˆ–in=gq è¯†åˆ«å›½æ—— å¦‚æžœåŠ å‚æ•° in=flag åˆ™è¯†åˆ«å›½æ—— è„šæœ¬æ“ä½œå‰é¢ä¸è¦æ·»åŠ å›½æ——æ“ä½œ å¦åˆ™ç§»é™¤å›½æ——åŽé¢è„šæœ¬è¯†åˆ«ä¸åˆ°
 * [in=quan] è¯†åˆ«è‹±æ–‡å…¨ç§°

 *
 * [out=]   è¾“å‡ºèŠ‚ç‚¹åå¯é€‰å‚æ•°: (cnæˆ–zh ï¼Œusæˆ–en ï¼Œgqæˆ–flag ï¼Œquan) å¯¹åº”ï¼š(ä¸­æ–‡ï¼Œè‹±æ–‡ç¼©å†™ ï¼Œå›½æ—— ï¼Œè‹±æ–‡å…¨ç§°) é»˜è®¤ä¸­æ–‡ ä¾‹å¦‚ [out=en] æˆ– out=us è¾“å‡ºè‹±æ–‡ç¼©å†™
 *** åˆ†éš”ç¬¦å‚æ•°
 *
 * [fgf=]   èŠ‚ç‚¹åå‰ç¼€æˆ–å›½æ——åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºæ ¼ï¼›
 * [sn=]    è®¾ç½®å›½å®¶ä¸Žåºå·ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºæ ¼ï¼›
 * åºå·å‚æ•°
 * [one]    æ¸…ç†åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°åŒºçš„01
 * [flag]   ç»™èŠ‚ç‚¹å‰é¢åŠ å›½æ——
 *
 *** å‰ç¼€å‚æ•°
 * [name=]  èŠ‚ç‚¹æ·»åŠ æœºåœºåç§°å‰ç¼€ï¼›
 * [nf]     æŠŠ name= çš„å‰ç¼€å€¼æ”¾åœ¨æœ€å‰é¢
 *** ä¿ç•™å‚æ•°
 * [blkey=iplc+gpt+NF+IPLC] ç”¨+å·æ·»åŠ å¤šä¸ªå…³é”®è¯ ä¿ç•™èŠ‚ç‚¹åçš„è‡ªå®šä¹‰å­—æ®µ éœ€è¦åŒºåˆ†å¤§å°å†™!
 * å¦‚æžœéœ€è¦ä¿®æ”¹ ä¿ç•™çš„å…³é”®è¯ æ›¿æ¢æˆåˆ«çš„ å¯ä»¥ç”¨ > åˆ†å‰² ä¾‹å¦‚ [#blkey=GPT>æ–°åå­—+å…¶ä»–å…³é”®è¯] è¿™å°†æŠŠã€GPTã€‘æ›¿æ¢æˆã€æ–°åå­—ã€‘
 * ä¾‹å¦‚      https://raw.githubusercontent.com/Keywos/rule/main/rename.js#flag&blkey=GPT>æ–°åå­—+NF
 * [blgd]   ä¿ç•™: å®¶å®½ IPLC Ë£Â² ç­‰
 * [bl]     æ­£åˆ™åŒ¹é…ä¿ç•™ [0.1x, x0.2, 6x ,3å€]ç­‰æ ‡è¯†
 * [nx]     ä¿ç•™1å€çŽ‡ä¸Žä¸æ˜¾ç¤ºå€çŽ‡çš„
 * [blnx]   åªä¿ç•™é«˜å€çŽ‡
 * [clear]  æ¸…ç†ä¹±å
 * [blpx]   å¦‚æžœç”¨äº†ä¸Šé¢çš„blå‚æ•°,å¯¹ä¿ç•™æ ‡è¯†åŽçš„åç§°åˆ†ç»„æŽ’åº,å¦‚æžœæ²¡ç”¨ä¸Šé¢çš„blå‚æ•°å•ç‹¬ä½¿ç”¨blpxåˆ™ä¸èµ·ä»»ä½•ä½œç”¨
 * [blockquic] blockquic=on é˜»æ­¢; blockquic=off ä¸é˜»æ­¢
 */

const inArg = $arguments || {};

const clear = inArg.clear === true || inArg.clear === 'true';
const nm = inArg.nm === true || inArg.nm === 'true';
const addFlag = inArg.flag === true || inArg.flag === 'true';
const prefixName = inArg.name ? decodeURI(inArg.name) : '';
const FGF = ' ';

const nameclear = /(å¥—é¤|åˆ°æœŸ|æœ‰æ•ˆ|å‰©ä½™|ç‰ˆæœ¬|å·²ç”¨|è¿‡æœŸ|å¤±è”|æµ‹è¯•|å®˜æ–¹|ç½‘å€|å¤‡ç”¨|ç¾¤|TEST|å®¢æœ|ç½‘ç«™|èŽ·å–|è®¢é˜…|æµé‡|æœºåœº|ä¸‹æ¬¡|å®˜å€|è”ç³»|é‚®ç®±|å·¥å•|å­¦æœ¯|USE|USED|TOTAL|EXPIRE|EMAIL)/i;

// å›½å®¶ä¸Žå›½æ——å¯¹åº”ï¼ˆç®€åŒ–ç‰ˆï¼ŒæŒ‰éœ€è¦æ‰©å±•ï¼‰
const countryMap = {
  'é¦™æ¸¯': 'ðŸ‡­ðŸ‡°',
  'æ¾³é—¨': 'ðŸ‡²ðŸ‡´',
  'å°æ¹¾': 'ðŸ‡¹ðŸ‡¼',
  'æ—¥æœ¬': 'ðŸ‡¯ðŸ‡µ',
  'éŸ©å›½': 'ðŸ‡°ðŸ‡·',
  'æ–°åŠ å¡': 'ðŸ‡¸ðŸ‡¬',
  'ç¾Žå›½': 'ðŸ‡ºðŸ‡¸',
  'è‹±å›½': 'ðŸ‡¬ðŸ‡§',
  'æ³•å›½': 'ðŸ‡«ðŸ‡·',
  'å¾·å›½': 'ðŸ‡©ðŸ‡ª',
  'æ¾³å¤§åˆ©äºš': 'ðŸ‡¦ðŸ‡º',
  'é˜¿è”é…‹': 'ðŸ‡¦ðŸ‡ª',
  // ...æ ¹æ®éœ€è¦è¡¥å……
};

// å…¼å®¹è‹±æ–‡ç®€å†™ï¼ˆç®€å†™åˆ°å›½å®¶ä¸­æ–‡åï¼‰
const countryAlias = {
  'HK': 'é¦™æ¸¯',
  'MO': 'æ¾³é—¨',
  'TW': 'å°æ¹¾',
  'JP': 'æ—¥æœ¬',
  'KR': 'éŸ©å›½',
  'SG': 'æ–°åŠ å¡',
  'US': 'ç¾Žå›½',
  'GB': 'è‹±å›½',
  'FR': 'æ³•å›½',
  'DE': 'å¾·å›½',
  'AU': 'æ¾³å¤§åˆ©äºš',
  'AE': 'é˜¿è”é…‹',
  // ...æ ¹æ®éœ€è¦è¡¥å……
};

function getFlagByName(name) {
  for (const key in countryMap) {
    if (name.includes(key)) return countryMap[key];
  }
  // å°è¯•è‹±æ–‡ç®€å†™åŒ¹é…
  for (const key in countryAlias) {
    if (name.includes(key)) {
      const cn = countryAlias[key];
      return countryMap[cn] || '';
    }
  }
  return '';
}

function operator(proxies) {
  if (!Array.isArray(proxies)) return proxies;

  // å…ˆè¿‡æ»¤æ— ç”¨èŠ‚ç‚¹
  if (clear) {
    proxies = proxies.filter(item => !nameclear.test(item.name));
  }

  // åŠ å‰ç¼€ï¼Œå¢žæ·»å›½æ——
  proxies.forEach(item => {
    let newName = item.name;

    if (prefixName) {
      newName = prefixName + newName;
    }

    // æ·»åŠ å›½æ——
    if (addFlag) {
      const flag = getFlagByName(item.name);
      if (flag) {
        newName = flag + ' ' + newName;
      } // elseä¸å¤„ç†ï¼Œä¸å¼ºåˆ¶æ·»åŠ å›½æ——
    }

    item.name = newName;
  });

  // nmä¸ºtrueæ—¶ä¿ç•™æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¸åšå…¶ä»–è¿‡æ»¤ï¼Œfalseåˆ™è¿‡æ»¤æŽ‰æ²¡åç§°æˆ–å¯èƒ½ç©ºåèŠ‚ç‚¹
  if (!nm) {
    proxies = proxies.filter(item => item.name && item.name.trim() !== '');
  }

  return proxies;
}

// æ‰§è¡Œ
operator($items);
